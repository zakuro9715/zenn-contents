---
title     : 開発者から見た V 言語とその(誇大)広告について
type      : tech
emoji     : 👀
topics    : ["vlang"]
published : true
---

# V 言語について

一時期話題になった [V 言語](https://vlang.io)ですが、みなさまは覚えているでしょうか。



https://twitter.com/linda_pp/status/1093409504744468481

Go にインスパイアされたシンプルな構文、NoGC かつ Rust のような難しさもないメモリ管理。小さいバイナリサイズと高速なコンパイル、ホットリロードなど、様々な目玉機能を謳って登場した言語でした。

発表するが公開しない。バイナリは公開するがオープンソースにはしないなど、期待感をあおる情報の出し方をしたのもあって、当初こそそれなりに話題になりましたが、今となっては誰も話題にしなくなった感は否めません。

ところで、会社が消滅して無職になった私は、数か月前から V 言語の開発に参加しており、執筆時点で #25 の Contributor になっています。

私が知る限り、アクティブに活動している日本人の開発者はほとんどいません。

そこで、コミュニティにも慣れ V 言語のことが少しづつわかってきたこのタイミングで、V 言語の現状について書きたいと思います。

# 広告とその実装

V 言語は当初からかなり強気のアピールをしており、それは現在においても変わりません。

[公式サイト](https://vlang.io)では、以下のようなことを謳っています。

- 他の言語より早くて小さいコンパイラ（1 秒未満のビルド時間で2 MB 未満のバイナリサイズ）
- NoGC でありながら、簡単で安全な自動メモリ管理
- C translation (wip)
- クロスコンパイル
- Run everywhere

特に、速度の部分やメモリ管理の部分などは、目玉機能として取り上げられることがおおいです。

結論から言ってしまうと、これらには誇大広告と言わざるを得ない部分が多数あります。

一応開発者として言い訳をすると、広告で嘘をつくつもりはありません。書かれていることを目指して開発をしていますし、開発は日進月歩で進んでいます。とはいえ誇大広告であることは確かであり、これは開発コミュニティの性質によるものだと考えています。

## コンパイラ

公式サイトには、V コンパイラは小さく、コンパイル時間も短いと書かれています。では実際にはどうかということを確認してみましょう[^1][^2]

[^1]: 使用する環境は WSL2, CPU: Ryzen7 3800X, 40GB 2133MHz、ストレージ: CT500MX500SSD1 です。
[^2]: clang バックエンドを使用しています。

### サイズ

V コンパイラを C に変換した v.c のサイズは、確かに以前は 2MB を切っていました。現在はこれを少し超えてしまっているので、修正しようということが discord 提案されています

ところで、基本的に V コンパイラは C 言語へのトランスコンパイラとして実装されています。x86 と JS のバックエンドも一応ありますが、現状おまけ程度です。

ということで、V コンパイラは C コンパイラを必要とします。ところが、V コンパイラのバイナリには当然 C コンパイラは含まれていません。公式サイトでは Go や Swift などと比較していますが、これらは単一で動作するバイナリのサイズであり、それらと比較するのは詐欺と言わざるを得ません。

ただ、サイズが小さいということ自体は嘘ではありません。公式サイトからダウンロードできる zip は解凍すると 20 MB 未満ですが、標準ライブラリとソースコード、および tcc などの依存ライブラリも含まれており、それ単体でコンパイラとして動作します。

### コンパイル時間

また、公式サイトにはコンパイル時間が 1秒未満と書かれています。

確かに V のセルフコンパイルは速いです。計測してみたところ 1.5 秒程度でセルフコンパイルが完了します。マシン次第では 1秒未満というのも嘘ではないかもしれません。

確認したところ、vlib/v はテストを除いて 4 万行ほどあります。公式サイトには 8万行 をコンパイルできるとあるため、これもマシンによっては嘘ではない可能性があります。

もっとも、公式サイトには i5-7500 と書かれているため、やっぱりサイトの記述は嘘のような気もしますが、7 年前のラップトップを使用しているといっているデモ動画[^3]でのコンパイルは手元の環境より数倍速いので、環境の問題かもしれません。

[^3]: [youtube](https://www.youtube.com/watch?v=gmB8ea8uLsM)

V 言語は C 言語へのトランスパイラなので、V コンパイラが速いのではなく C コンパイラが速いのだという指摘もあります。そういう側面は確かに大きいのですが、V コンパイラ自体もそれなりに高速です（構文解析、型チェック、コード生成までは V 言語が行いますが、コンパイルに占める時間の大半は C のコンパイルです）。

ところで、ここまで書いてきたコンパイル時間は、すべて最適化しない場合のコンパイル時間です。最適化を有効にすると、手元の環境ではセルフコンパイルに 15 秒程度かかります。それでも十分に速くはあるのですが、やや詐欺という感は否めません。

## クロスコンパイル

公式サイトにはクロスコンパイルが簡単にできると書いてあります。これは簡単の定義も人によって異なるため、何とも言えないところがあります。オプションを付けるだけでいいという Golang ほどの簡単さではありません。たとえば、windows 向けのコンパイルには mingw の gcc を入れる必要があります

そもそも C へのトランスパイラですから、対応する C コンパイラがあれば確かにクロスコンパイルはできます。

## Run everywhere

これも上記と同様です。C コンパイラがあれば当然コンパイルはできるし、動作します。

一応 CI では Linux、Windows、macOS のほか、FreeBSD や Soralis、Dragonfly BSD などでもテストが実行されています。

また、Android などスマートフォンの実機で動作させている動画もあり、将来的には GUI ライブラリもモバイルで動くようにする方向性のようです。

## メモリ管理

V 言語には GC はなく、自動でメモリ管理してくれます。また、Rust のような難しさはなく、私は Go と同じ感覚で書いています。

V 言語のメモリ管理は [Lobster という言語のメモリ管理](https://aardappel.github.io/lobster/memory_management.html)を参考にしているようです。

0.2 の時点でそれなりに動作しており、Ved という V 言語で書かれたテキストエディタはメモリリークなしで動作します。

@[youtube](https://www.youtube.com/watch?v=gmB8ea8uLsM)

ただし、現状で動作は完全ではなく、依然としてメモリリークは発生します。

## C translation

WIP ということになっており、今のところ使用できません。また、作業状況も公開されていないため、どの程度進んでいるのかも不明です。v0.3 でリリースすることになっています。

作者の Alex は他言語からの変換に意欲的なようなので、放棄されることはないように思います。また、Go からの変換を実装しようという動きもあります。

# V 言語コミュニティの話

V 言語コミュニティは非常に活発です。毎日それなりの数の Issue と PR が出され、マージされています。スピード感も非常に速く、PR を出せば 24 時間以内にコメントが付き、そのままマージされることも多いです。

平日休日を問わず、クリスマスも正月も、開発は活発です。

私見ですが、V 言語の開発者はどんどん実装していくタイプの人が多く、いろいろな機能がすぐに実装されていきます。最近では、Lanugauge Server の開発が始まってから比較的すぐに役に立つレベルになっています。

一方で、レビューはあまく、細かいバグは非常に多いです。私は V 言語の開発者としては珍しいタイプで、発見されたバグを修正することをメインに活動しています。

V 言語の広告についても、どんどんやっていくという勢いのあるコミュニティの性格が出ているように感じます。

# 最後に

V 言語の広告に誇大な部分がありますし、やや勢い余ってしまっているのはたしかです。しかし、嘘をついたり騙したりしたいわけではありません。

V 言語の実装ペースは早く、日々機能が追加されています。次回の v0.3 の後には、v1.0 で構文を固定化することになっています。現状ではまだまだプロダクションに耐えうる言語ではありませんが、そうなる日は遠くないかもしれません。

前述のとおり、V 言語は機能の実装を優先するところがあり、細かい取りこぼしがかなり多くあります。開発者の人数も多くないため、少しでも人手が欲しいという状態です。PR はかなりあっさりとマージされることも多く、参加しやすい OSS だと思うので、興味があれば是非一度 PR を送ってみてください。

## リンク

- [vlang.io](https://vlang.io)
- [vlang/v](https://github.com/vlang/v)

# 余談

## volt ってどうなったの？

そもそも V 言語は volt という GUI アプリケーションを作るために開発された言語でした。

V 言語が活発に開発されている中、volt に関してはアナウンスがなく、当初の公式サイトも消滅しています。

私もてっきりプロジェクト自体が消滅したのかと思っていましたが、どうやらそうではないようです。ドメインは変わっていますが[公式サイト](https://volt-app.com)も存在します。

Discord でも「消滅したの？」みたいなコメントが時々出てきますが、そのたびに「もうすぐベータ版がダウンロードできるようになる」と返答があり、開発は続いているようです。ただ、常に「もうすぐ」と言っているので、実際のところいつになるのかはわかりません。
