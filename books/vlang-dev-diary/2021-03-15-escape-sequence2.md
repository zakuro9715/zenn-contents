---
title: '2021/03/15 - unicode のエスケープシーケンスを自前でデコード & v fmt のために残す情報の話
---

先日書いたとおり、V言語はエスケープシーケンスをそのまま C に渡しており、Unicode のエスケープシーケンスで問題が発生していた。その時点ではとりあえず ascii を使用できるようにしたが、本質的には問題は解決していなかった。

そもそも、C言語の仕様を読む限りでは、`\uXXXX` は Unicode ではなく Universal Character と書いてあり、また UTF-8 として解釈するとは書かれていない。V言語の文字列は UTF-8 なので、これは UTF-8 として解釈されないと問題がある。

ということで、`\uXXXX` に関しては、scanner の段階で UTF-8 としてデコードするように実装した。

[scanner: decode \uXXXX in scanner #9298](https://github.com/vlang/v/pull/9298)

ところで、PR を出す直前に気づいたのだが、scanner の段階でこれをやってしまうと、エスケープシーケンスの情報が AST に残らない。V言語には v fmt というフォーマッタがあり、これは AST を文字列に復元するという実装なので、AST に残らないということは、v fmt に渡すとエスケープシーケンスが普通の文字列に置換されてしまうということになる。よって、fmt のときにはデコードしないという条件分岐を入れてやる必要がある。
